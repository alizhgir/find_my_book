import streamlit as st
import pandas as pd
import numpy as np
import time
import base64
import requests
from PIL import Image
from io import BytesIO

from model.bert import recommend


LIST_GENRE = ['–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–∑–∞', '–û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ç–µ–∫—Ç–∏–≤—ã',
              '–ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –¥–µ—Ç–µ–∫—Ç–∏–≤—ã', '–ò—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–µ–∫—Ç–∏–≤—ã', '–û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', '–ó–∞—Ä—É–±–µ–∂–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
              '–û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ñ—ç–Ω—Ç–µ–∑–∏', '–ó–∞—Ä—É–±–µ–∂–Ω–æ–µ —Ñ—ç–Ω—Ç–µ–∑–∏', '–£–∂–∞—Å—ã', '–§–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–π –±–æ–µ–≤–∏–∫',
              '–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ª—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã', '–ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –ª—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã', '–ü–æ—ç–∑–∏—è', '–î—Ä–∞–º–∞—Ç—É—Ä–≥–∏—è',
              '–ü—É–±–ª–∏—Ü–∏—Å—Ç–∏–∫–∞', '–ë–∏–æ–≥—Ä–∞—Ñ–∏–∏', '–ú–µ–º—É–∞—Ä—ã', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ä–æ–º–∞–Ω—ã', '–ö–æ–º–∏—Å–∫—Å—ã –∏ –º–∞–Ω–≥–∞', '–Æ–º–æ—Ä',
              '–ê—Ñ–æ—Ä–∏–∑–º—ã –∏ —Ü–∏—Ç–∞—Ç—ã', '–ú–∏—Ñ—ã –ª–µ–≥–µ–Ω–¥—ã —ç–ø–æ—Å', '–°–∫–∞–∑–∫–∏', '–ü–æ—Å–ª–æ–≤–∏—Ü—ã –ø–æ–≥–æ–≤–æ—Ä–∫–∏ –∑–∞–≥–∞–¥–∫–∏', '–ü—Ä–æ—á–∏–µ –∏–∑–¥–∞–Ω–∏—è', '–î—Ä—É–≥–æ–µ']


st.header("""
 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è –º–æ–¥–µ–ª—åü§ñ
""", divider='blue')

st.info("""
  ##### –ß—É—Ç—å –Ω–∏–∂–µ –í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—É—é –í—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –∏ –≤—ã–±—Ä–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞‚öôÔ∏è
""")

st.image('images/recsys_image.png', caption='–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ DALL-E')

st.write("""
  - ### –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞:
""")

text_users = st.text_input('**–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –≤—ã–±–æ—Ä—É –∫–Ω–∏–≥–∏ (–∫–∞–∫–æ–π –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å):**')

genre_book = st.selectbox('**–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∂–∞–Ω—Ä –∫–Ω–∏–≥–∏:**', options=LIST_GENRE, index=None)

count_recommended = st.slider('**–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–∞–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –í—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å:**', min_value=1, max_value=10, value=5)

push_button = st.button('**–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ >>>**', type='primary')
start_time = time.time()

if push_button:

    recommend_book, value_metrics = recommend(text_users, count_recommended)

    st.write("""
     #### –ú–æ–¥–µ–ª—å –Ω–∞—à–ª–∞ –ª—É—á—à–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –í–∞—Åüéâ :
    """)
    st.info(f"""
    - ##### –≠—Ç–æ –∑–∞–Ω—è–ª–æ –≤—Å–µ–≥–æ {round(time.time() - start_time, 3)} —Å–µ–∫.
    """)

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.write('##### –û–±–ª–æ–∂–∫–∞')

    with col2:
        st.write('##### –ò–Ω—Ñ–æ')

    with col3:
        st.write('##### –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è')

    with col4:
        st.write('##### –í–µ–ª–∏—á–∏–Ω–∞ —Å—Ö–æ–¥—Å—Ç–≤–∞ (–ï–≤–∫–ª–∏–¥–æ–≤–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ)')
    st.divider()

    for index in range(count_recommended):
        col1, col2, col3, col4 = st.columns(4)

        response = requests.get(recommend_book.loc[index, '–û–±–ª–æ–∂–∫–∞'])

        image_bytes = BytesIO(response.content)
        image = Image.open(image_bytes)

        with col1:
            st.image(image)

        with col2:
            st.write(f"{recommend_book.loc[index, '–ò–Ω—Ñ–æ']}")

        with col3:
            st.write(f"{recommend_book.loc[index, '–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è']}")

        with col4:
            st.write(f'{value_metrics[index]}')
        st.divider()

    time.sleep(3)
    with st.sidebar:
        st.info("""
         #### –ü–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å –ª–∏ –í–∞–º –Ω–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏? 
        """)

        col1, col2 = st.columns(2)

        with col1:
            st.button('**–î–∞, –æ—á–µ–Ω—å**üî•', type='primary')
        with col2:
            st.button('**–ù–µ—Ç,–º–æ–∂–Ω–æ –ª—É—á—à–µ**üëéüèª', type='primary')
